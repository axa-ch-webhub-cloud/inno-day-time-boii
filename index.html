<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=Utf-8" />
    <script src="qrcode.js"></script>
    <script src="qr-scanner.js"></script>
    <script src="qr-scanner-worker.js"></script>

    <title>P2P Communication</title>
  </head>
  <body>
    <video width="300" height="170"></video>

    <table width="100%" border="1">
      <tbody>
        <tr>
          <th>#</th>
          <th>initiator</th>
          <th>peer</th>
        </tr>
        <tr>
          <td>step 1</td>
          <td>
            <input type="button" value="create offer" id="create-offer" />
            <input id="createdOffer" type="text" hidden="" />
          </td>
          <td></td>
        </tr>
        <tr>
          <td>step 2</td>
          <td></td>
          <td>
            <input
              id="remoteOffer"
              type="text"
              placeholder="offer from initiator"
            />
            <input type="button" value="accept offer" id="accept-offer" />
          </td>
        </tr>
        <tr>
          <td>step 3</td>
          <td></td>
          <td>
            <input type="button" value="create answer" id="create-answer" />
            <input id="createdAnswer" type="text" />
          </td>
        </tr>
        <tr>
          <td>step 4</td>
          <td>
            <input
              id="remoteAnswer"
              type="text"
              placeholder="answer from peer"
            />
            <input type="button" value="accept answer" id="accept-answer" />
          </td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <hr />
    <input id="text" type="text" />
    <input type="button" value="send" id="send-text" />
    <hr />
    <table border="1">
      <tbody>
        <tr>
          <th colspan="2">connection</th>
        </tr>
        <tr>
          <th>connectionState</th>
          <td id="connectionState">connected</td>
        </tr>
        <tr>
          <th>iceConnectionState</th>
          <td id="iceConnectionState">connected</td>
        </tr>
      </tbody>
    </table>

    QR Code Element
    <div id="qr"></div>
    <!-- / QR Code Element -->

    <script type="module">
      import QrScanner from './qr-scanner.js';
      const qrScanner = new QrScanner(
        document.querySelector('video'),
        (result) => {
          console.log('decoded qr code:', result);
          qrScanner.stop();
        }
      );
      //   qrScanner.start();

      let channel = null;

      const connection = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
      });

      connection.ondatachannel = (event) => {
        console.log('ondatachannel');
        channel = event.channel;
        // channel.onopen = event => console.log('onopen', event);
        // channel.onmessage = event => console.log('onmessage', event);
        channel.onmessage = (event) => alert(event.data);
      };

      connection.onconnectionstatechange = (event) =>
        (document.getElementById('connectionState').innerText =
          connection.connectionState); // console.log('onconnectionstatechange', connection.connectionState)
      connection.oniceconnectionstatechange = (event) =>
        (document.getElementById('iceConnectionState').innerText =
          connection.iceConnectionState); // console.log('oniceconnectionstatechange', connection.iceConnectionState)

      async function step_1_initiator_create_offer() {
        channel = connection.createDataChannel('data');
        // channel.onopen = event => console.log('onopen', event)
        // channel.onmessage = event => console.log('onmessage', event)
        channel.onmessage = (event) => alert(event.data);

        connection.onicecandidate = (event) => {
          // console.log('onicecandidate', event)
          if (!event.candidate) {
            var createdOffer = JSON.stringify(connection.localDescription);
            document.getElementById('createdOffer').value = createdOffer;
            document.getElementById('createdOffer').hidden = false;
            update_qrcode(createdOffer);
          }
        };

        const offer = await connection.createOffer();
        await connection.setLocalDescription(offer);
      }

      async function step_2_accept_remote_offer() {
        const offer = JSON.parse(document.getElementById('remoteOffer').value);
        await connection.setRemoteDescription(offer);
      }

      async function step_3_create_answer() {
        connection.onicecandidate = (event) => {
          // console.log('onicecandidate', event)
          if (!event.candidate) {
            var createdAnswer = JSON.stringify(connection.localDescription);
            document.getElementById('createdAnswer').value = createdAnswer;
            document.getElementById('createdAnswer').hidden = false;
            update_qrcode(createdAnswer);
          }
        };

        const answer = await connection.createAnswer();
        await connection.setLocalDescription(answer);
      }

      async function step_4_accept_answer() {
        const answer = JSON.parse(
          document.getElementById('remoteAnswer').value
        );
        await connection.setRemoteDescription(answer);
      }

      async function send_text() {
        const text = document.getElementById('text').value;

        channel.send(text);
      }

      document.querySelector('#create-offer').addEventListener('click', () => {
        step_1_initiator_create_offer();
      });
      document.querySelector('#accept-offer').addEventListener('click', () => {
        step_2_accept_remote_offer();
      });
      document.querySelector('#create-answer').addEventListener('click', () => {
        step_3_create_answer();
      });
      document.querySelector('#accept-answer').addEventListener('click', () => {
        step_4_accept_answer();
      });
      document.querySelector('#send-text').addEventListener('click', () => {
        send_text();
      });
    </script>
  </body>
</html>
